name: Deploy Ansible Playbooks

on:
  push:
    branches:
      - main
    paths:
      - '*.yml'
      - '*.yaml'
      - 'requirements.yml'
      - 'group_vars/**'
      - 'host_vars/**'
      - 'inventory/**'
  workflow_dispatch:
    inputs:
      playbooks:
        description: 'Specific playbooks to run (comma-separated, e.g., dagu-coordinator.yml,personal.yml). Leave empty to run all changed playbooks.'
        required: false
        type: string

jobs:
  detect-playbooks:
    name: Detect Changed Playbooks
    runs-on: ubuntu-latest
    outputs:
      playbooks: ${{ steps.detect.outputs.playbooks }}
      has_playbooks: ${{ steps.detect.outputs.has_playbooks }}
      collections_changed: ${{ steps.detect.outputs.collections_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed playbooks
        id: detect
        run: |
          # Manual trigger with specific playbooks
          if [ -n "${{ github.event.inputs.playbooks }}" ]; then
            echo "Manual trigger - using specified playbooks: ${{ github.event.inputs.playbooks }}"
            PLAYBOOKS="${{ github.event.inputs.playbooks }}"
            # Convert comma-separated list to JSON array
            PLAYBOOKS_JSON=$(echo "$PLAYBOOKS" | jq -R -s -c 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$";""))')
            echo "playbooks=$PLAYBOOKS_JSON" >> $GITHUB_OUTPUT
            echo "has_playbooks=true" >> $GITHUB_OUTPUT
            echo "collections_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Automatic trigger - detect changes
          # Handle initial commit (no HEAD~1)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # First commit - show all files
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
          fi

          # Check if collections requirements changed
          if echo "$CHANGED_FILES" | grep -qE "^requirements\.ya?ml$"; then
            echo "collections_changed=true" >> $GITHUB_OUTPUT
          else
            echo "collections_changed=false" >> $GITHUB_OUTPUT
          fi

          # Find all changed playbook files in root directory only
          # Match both .yml and .yaml extensions
          # Exclude requirements.yml/yaml
          CHANGED_PLAYBOOKS=$(echo "$CHANGED_FILES" | \
            grep -E "^[^/]*\.ya?ml$" | \
            grep -vE "^requirements\.ya?ml$" || true)

          if [ -z "$CHANGED_PLAYBOOKS" ]; then
            echo "No playbook changes detected"
            echo "playbooks=[]" >> $GITHUB_OUTPUT
            echo "has_playbooks=false" >> $GITHUB_OUTPUT
          else
            echo "Changed playbooks:"
            echo "$CHANGED_PLAYBOOKS"

            # Convert to JSON array for matrix
            PLAYBOOKS_JSON=$(echo "$CHANGED_PLAYBOOKS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "playbooks=$PLAYBOOKS_JSON" >> $GITHUB_OUTPUT
            echo "has_playbooks=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy ${{ matrix.playbook }}
    runs-on: ubuntu-latest
    needs: detect-playbooks
    if: needs.detect-playbooks.outputs.has_playbooks == 'true'
    strategy:
      matrix:
        playbook: ${{ fromJson(needs.detect-playbooks.outputs.playbooks) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get secrets from Bitwarden
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          base_url: https://vault.bitwarden.eu
          secrets: |
            f942f933-552f-49bf-bc03-b39101441184 > TS_OAUTH_CLIENT_ID
            019095dc-43b6-4433-9dad-b39101444e03 > TS_OAUTH_SECRET
            02a4e11b-9799-4e86-92a2-b398016aa496 > ANSIBLE_CACHE_PLUGIN_CONNECTION

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ env.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ env.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and Redis
        run: |
          pip install ansible redis

      - name: Install Ansible Collections
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
        run: |
          ansible-galaxy collection install -r requirements.yml

      - name: Run Ansible Playbook - ${{ matrix.playbook }}
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          ANSIBLE_CACHE_PLUGIN_CONNECTION: ${{ env.ANSIBLE_CACHE_PLUGIN_CONNECTION }}
          ANSIBLE_FORCE_COLOR: 'true'
        run: |
          echo "Running playbook: ${{ matrix.playbook }}"
          ansible-playbook -v ${{ matrix.playbook }}

      - name: Summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Successfully deployed ${{ matrix.playbook }}"
          else
            echo "❌ Failed to deploy ${{ matrix.playbook }}"
          fi
